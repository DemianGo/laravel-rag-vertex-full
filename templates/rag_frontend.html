{% extends "base.html" %}

{% block title %}RAG Console - Sistema Inteligente{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 m-0">
            <i class="fas fa-brain me-2"></i>RAG Console - Sistema Inteligente
        </h1>
        <div class="d-flex gap-2">
            <button id="btnHealth" class="btn btn-outline-success btn-sm">
                <i class="fas fa-heartbeat me-1"></i>Teste Conexão
            </button>
            <button id="btnConfig" class="btn btn-outline-dark btn-sm">
                <i class="fas fa-cog me-1"></i>Configurar
            </button>
        </div>
    </div>

    <div class="alert alert-info" role="alert">
        <strong><i class="fas fa-info-circle me-1"></i>Sistema RAG Ativo:</strong> 
        Upload de documentos (TXT, PDF, JSON) e consultas inteligentes com IA.
        <br><small>Endpoints: <code>/api/rag/query</code>, <code>/api/rag/ingest</code></small>
    </div>

    <!-- Abas principais -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ingest" type="button">
                <i class="fas fa-upload me-1"></i>Upload de Documentos
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#chat" type="button">
                <i class="fas fa-comments me-1"></i>Chat com IA
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#docs" type="button">
                <i class="fas fa-file-alt me-1"></i>Documentos
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#python-rag" type="button">
                <i class="fas fa-python me-1"></i>Python RAG
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-4 rounded-bottom">
        <!-- UPLOAD DE DOCUMENTOS -->
        <div class="tab-pane fade show active" id="ingest">
            <div class="row g-4">
                <div class="col-md-6">
                    <h5><i class="fas fa-upload me-2"></i>Carregar Documento</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Título do Documento</label>
                        <input id="docTitle" class="form-control" placeholder="Nome do documento">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Arquivo (PDF, TXT, JSON)</label>
                        <input id="docFile" type="file" class="form-control" accept=".pdf,.txt,.json">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ou Cole Texto</label>
                        <textarea id="docText" class="form-control" rows="8" placeholder="Cole aqui o texto do documento..."></textarea>
                    </div>

                    <button id="btnUpload" class="btn btn-primary w-100">
                        <i class="fas fa-upload me-2"></i>Carregar Documento
                    </button>
                    
                    <div id="uploadProgress" class="mt-3 d-none">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                        <small id="progressText" class="text-muted">Carregando...</small>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5><i class="fas fa-list me-2"></i>Resultado</h5>
                    <div id="uploadResult" class="console-box">
                        Aguardando upload...
                    </div>
                </div>
            </div>
        </div>

        <!-- CHAT COM IA -->
        <div class="tab-pane fade" id="chat">
            <div class="row g-4">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label class="form-label">Documento (ID)</label>
                        <input id="chatDocId" type="number" class="form-control" placeholder="ID do documento (deixe vazio para último carregado)">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Pergunta</label>
                        <textarea id="chatQuery" class="form-control" rows="4" placeholder="Faça sua pergunta sobre o documento..."></textarea>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Modo</label>
                            <select id="chatMode" class="form-select">
                                <option value="direct">Direto</option>
                                <option value="summary">Resumo</option>
                                <option value="quote">Citação</option>
                                <option value="list">Lista</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Formato</label>
                            <select id="chatFormat" class="form-select">
                                <option value="plain">Texto</option>
                                <option value="markdown">Markdown</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Top K</label>
                            <input id="chatTopK" type="number" class="form-control" value="5" min="1" max="10">
                        </div>
                    </div>

                    <button id="btnChat" class="btn btn-success w-100">
                        <i class="fas fa-question-circle me-2"></i>Perguntar
                    </button>
                </div>

                <div class="col-md-4">
                    <h5><i class="fas fa-history me-2"></i>Últimos Documentos</h5>
                    <div id="recentDocs" class="console-box">
                        <small class="text-muted">Carregue um documento primeiro</small>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h5><i class="fas fa-robot me-2"></i>Resposta da IA</h5>
                <div id="chatResult" class="console-box">
                    Faça uma pergunta para ver a resposta...
                </div>
            </div>
        </div>

        <!-- LISTA DE DOCUMENTOS -->
        <div class="tab-pane fade" id="docs">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-file-alt me-2"></i>Documentos Carregados</h5>
                <button id="btnRefreshDocs" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-sync-alt me-1"></i>Atualizar Lista
                </button>
            </div>
            
            <div id="docsList" class="console-box">
                <small class="text-muted">Carregando lista de documentos...</small>
            </div>
        </div>

        <!-- PYTHON RAG AVANÇADO -->
        <div class="tab-pane fade" id="python-rag">
            <div class="row">
                <div class="col-12 col-xl-6">
                    <h5><i class="fas fa-python me-2"></i>Python RAG Avançado</h5>
                    <p class="text-muted">Sistema Python com modos de resposta, formatos e busca híbrida</p>
                    
                    <!-- Seção de Upload de Vídeo -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-video me-2"></i>Processamento de Vídeo YouTube</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">URL do Vídeo YouTube</label>
                                <input id="videoUrl" class="form-control" placeholder="https://www.youtube.com/watch?v=...">
                                <small class="form-text text-muted">Cole a URL completa do vídeo do YouTube</small>
                            </div>
                            <button id="processVideoBtn" class="btn btn-success">
                                <i class="fas fa-play me-2"></i>Processar Vídeo
                            </button>
                            <button id="videoStatusBtn" class="btn btn-outline-info ms-2" style="display: none;">
                                <i class="fas fa-info-circle me-1"></i>Status
                            </button>
                        </div>
                        <div class="card-footer">
                            <div id="videoStatus" class="mb-2"></div>
                            <div id="videoProgress" class="progress mb-2" style="display: none;">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Query/Pergunta</label>
                        <input id="pythonQuery" class="form-control" placeholder="Digite sua pergunta aqui...">
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-4">
                            <label class="form-label">Top-K</label_index>
                            <input id="pythonTopK" class="form-control" type="number" value="5" min="1" max="20">
                        </div>
                        <div class="col-4">
                            <label class="form-label">Threshold</label>
                            <input id="pythonThreshold" class="form-control" type="number" value="0.3" min="0.05" max="1.0" step="0.05">
                        </div>
                        <div class="col-4">
                            <label class="form-label">Document ID</label>
                            <input id="pythonDocId" class="form-control" type="number" placeholder="Opcional">
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <div class="form-check">
                            <input id="pythonIncludeAnswer" class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">Incluir resposta LLM</label>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label">Strictness (0-3)</label>
                        <select id="pythonStrictness" class="form-select">
                            <option value="0">0 - Muito Permissivo</option>
                            <option value="1">1 - Permissivo</option>
                            <option value="2" selected>2 - Moderado (Padrão)</option>
                            <option value="3">3 - Rigoroso (Sem LLM)</option>
                        </select>
                        <small class="form-text text-muted">Nível 3 pula LLM conforme PROJECT_README.md</small>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label">Modo</label>
                            <select id="pythonMode" class="form-select">
                                <option value="auto" selected>Auto (Detecta)</option>
                                <option value="direct">Direct</option>
                                <option value="summary">Summary</option>
                                <option value="quote">Quote</option>
                                <option value="list">List</option>
                                <option value="table">Table</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Formato</label>
                            <select id="pythonFormat" class="form-select">
                                <option value="plain" selected>Plain</option>
                                <option value="markdown">Markdown</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label">Comprimento</label>
                            <select id="pythonLength" class="form-select">
                                <option value="auto" selected>Auto</option>
                                <option value="short">Short</option>
                                <option value="medium">Medium</option>
                                <option value="long">Long</option>
                                <option value="xl">XL</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Citações (0-10)</label>
                            <input id="pythonCitations" class="form-control" type="number" value="0" min="0" max="10">
                        </div>
                    </div>
                    
                    <button id="pythonSearchBtn" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Buscar Python RAG
                    </button>
                    <button id="pythonCompareBtn" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-balance-scale me-2"></i>Comparar PHP vs Python
                    </button>
                    <button id="pythonHealthBtn" class="btn btn-outline-info ms-2">
                        <i class="fas fa-heartbeat me-2"></i>Health Check
                    </button>
                </div>
                
                <div class="col-12 col-xl-6">
                    <h6><i class="fas fa-chart-bar me-2"></i>Resultados</h6>
                    <div id="pythonStatus" class="mb-3"></div>
                    
                    <div class="mb-3">
                        <h6>Chunks Encontrados</h6>
                        <div id="pythonChunks" class="console-box" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Resposta LLM</h6>
                        <div id="pythonAnswer" class="console-box"></div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Metadados</h6>
                        <pre id="pythonMetadata" class="console-box" style="max-height: 200px; overflow-y: auto; font-size: 0.8em;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Console de Debug (flutuante) -->
<div class="float-console d-none" id="debugConsole">
    <div class="fc-head d-flex justify-content-between align-items-center px-3">
        <strong>Debug Console</strong>
        <button id="btnCloseConsole" class="btn btn-sm btn-outline-light">×</button>
    </div>
    <div class="fc-body" id="consoleLog">
        <div class="fc-item">
            <small class="text-muted">Console iniciado...</small>
        </div>
    </div>
</div>

<!-- Modal de Configuração -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">URL Base da API</label>
                    <input id="configApiUrl" class="form-control" placeholder="http://localhost:8000">
                </div>
                <div class="mb-3">
                    <label class="form-label">Tenant</label>
                    <input id="configTenant" class="form-control" value="default">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnSaveConfig">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Transcrição de Vídeo -->
<div class="modal fade" id="videoTranscriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-video me-2"></i>Transcrição do Vídeo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 id="videoTitle" class="text-primary"></h6>
                    <small id="videoInfo" class="text-muted"></small>
                </div>
                <div class="mb-3">
                    <h6>Transcrição:</h6>
                    <div id="videoTranscription" class="border p-3 rounded" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;"></div>
                </div>
                <div class="mb-3">
                    <h6>Downloads:</h6>
                    <div id="videoDownloads" class="d-flex gap-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnUseInRAG">Usar no RAG</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializar funcionalidades
    initializeRagConsole();
    
    // Event listeners
    $('#btnHealth').click(testConnection);
    $('#btnConfig').click(showConfigModal);
    $('#btnUpload').click(uploadDocument);
    $('#btnChat').click(askQuestion);
    $('#btnRefreshDocs').click(loadDocuments);
    $('#processVideoBtn').click(processVideo);
    $('#pythonSearchBtn').click(pythonRagSearch);
    $('#pythonHealthBtn').click(pythonHealthCheck);
});

function initializeRagConsole() {
    console.log('🚀 Inicializando RAG Console...');
    loadDocuments();
}

function testConnection() {
    $.get('/api/health')
        .done(function(response) {
            showAlert('✅ Conexão estabelecida com sucesso!', 'success');
        })
        .fail(function() {
            showAlert('❌ Erro na conexão com a API', 'danger');
        });
}

function showConfigModal() {
    $('#configModal').modal('show');
}

function uploadDocument() {
    const title = $('#docTitle').val() || 'Documento sem título';
    const file = $('#docFile')[0].files[0];
    const text = $('#docText').val();
    
    if (!file && !text) {
        showAlert('⚠️ Selecione um arquivo ou cole texto', 'warning');
        return;
    }
    
    $('#uploadProgress').removeClass('d-none');
    $('#progressBar').css('width', '30%');
    $('#progressText').text('Enviando documento...');
    
    let formData = new FormData();
    formData.append('title', title);
    
    if (file) {
        formData.append('file', file);
    } else {
        // Criar arquivo temporário com o texto
        const blob = new Blob([text], { type: 'text/plain' });
        formData.append('file', blob, 'documento.txt');
    }
    
    $.ajax({
        url: '/api/documents/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            $('#progressBar').css('width', '100%');
            $('#progressText').text('Documento processado com sucesso!');
            
            setTimeout(function() {
                $('#uploadProgress').addClass('d-none');
                $('#uploadResult').html(`✅ Documento "${title}" carregado com sucesso!<br>ID: ${response.document_id}<br>Chunks criados: ${response.chunks_created || 'N/A'}`);
                loadDocuments();
            }, 1000);
        },
        error: function(xhr) {
            $('#uploadProgress').addClass('d-none');
            showAlert('❌ Erro no upload: ' + xhr.responseJSON?.detail || 'Erro desconhecido', 'danger');
        }
    });
}

function askQuestion() {
    const query = $('#chatQuery').val();
    const docId = $('#chatDocId').val();
    const mode = $('#chatMode').val();
    const format = $('#chatFormat').val();
    const topK = $('#chatTopK').val();
    
    if (!query) {
        showAlert('⚠️ Digite uma pergunta', 'warning');
        return;
    }
    
    $('#chatResult').html('<i class="fas fa-spinner fa-spin me-2"></i>Processando pergunta...');
    
    const requestData = {
        query: query,
        document_id: docId || null,
        top_k: parseInt(topK),
        mode: mode,
        format: format
    };
    
    $.post('/api/rag/query', requestData)
        .done(function(response) {
            let result = `🔍 <strong>Pergunta:</strong> ${query}<br><br>`;
            
            if (response.chunks && response.chunks.length > 0) {
                result += `📄 <strong>Chunks encontrados (${response.chunks.length}):</strong><br>`;
                response.chunks.forEach((chunk, index) => {
                    result += `${index + 1}. ${chunk.content.substring(0, 200)}...<br><br>`;
                });
            }
            
            if (response.answer) {
                result += `🤖 <strong>Resposta da IA:</strong><br>${response.answer}<br><br>`;
            }
            
            result += `⏱️ <strong>Tempo de processamento:</strong> ${response.processing_time?.toFixed(2)}s<br>`;
            result += `🎯 <strong>Modo usado:</strong> ${response.mode_used}`;
            
            $('#chatResult').html(result);
        })
        .fail(function(xhr) {
            $('#chatResult').html('❌ Erro na consulta: ' + (xhr.responseJSON?.detail || 'Erro desconhecido'));
        });
}

function loadDocuments() {
    $('#docsList').html('<i class="fas fa-spinner fa-spin me-2"></i>Carregando documentos...');
    
    $.get('/api/documents/list')
        .done(function(response) {
            if (response.documents && response.documents.length > 0) {
                let html = '<table class="table table-sm">';
                html += '<thead><tr><th>ID</th><th>Título</th><th>Fonte</th><th>Data</th><th>Ações</th></tr></thead><tbody>';
                
                response.documents.forEach(function(doc) {
                    html += `<tr>
                        <td>${doc.id}</td>
                        <td>${doc.title}</td>
                        <td>${doc.source}</td>
                        <td>${formatDate(doc.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectDocument(${doc.id})">Usar</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument(${doc.id})">Deletar</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                $('#docsList').html(html);
            } else {
                $('#docsList').html('<small class="text-muted">Nenhum documento encontrado</small>');
            }
        })
        .fail(function() {
            $('#docsList').html('<small class="text-danger">Erro ao carregar documentos</small>');
        });
}

function processVideo() {
    const url = $('#videoUrl').val();
    
    if (!url) {
        showAlert('⚠️ Digite a URL do vídeo', 'warning');
        return;
    }
    
    $('#videoProgress').removeClass('d-none');
    $('#videoStatus').html('<i class="fas fa-spinner fa-spin me-2"></i>Processando vídeo...');
    
    $.post('/api/video/process', { url: url })
        .done(function(response) {
            $('#videoProgress').addClass('d-none');
            $('#videoStatus').html('✅ Vídeo processado com sucesso!');
            
            if (response.transcription) {
                $('#videoTranscription').html(response.transcription);
                $('#videoTitle').text(`Vídeo: ${response.video_id}`);
                $('#videoInfo').text(`Status: ${response.status}`);
                $('#videoTranscriptionModal').modal('show');
            }
        })
        .fail(function(xhr) {
            $('#videoProgress').addClass('d-none');
            $('#videoStatus').html('❌ Erro no processamento: ' + (xhr.responseJSON?.detail || 'Erro desconhecido'));
        });
}

function pythonRagSearch() {
    const query = $('#pythonQuery').val();
    
    if (!query) {
        showAlert('⚠️ Digite uma pergunta', 'warning');
        return;
    }
    
    $('#pythonStatus').html('<i class="fas fa-spinner fa-spin me-2"></i>Buscando...');
    
    const requestData = {
        query: query,
        top_k: parseInt($('#pythonTopK').val()),
        threshold: parseFloat($('#pythonThreshold').val()),
        document_id: $('#pythonDocId').val() || null,
        mode: $('#pythonMode').val(),
        format: $('#pythonFormat').val(),
        strictness: parseInt($('#pythonStrictness').val()),
        include_answer: $('#pythonIncludeAnswer').is(':checked'),
        length: $('#pythonLength').val(),
        citations: parseInt($('#pythonCitations').val())
    };
    
    $.post('/api/rag/query', requestData)
        .done(function(response) {
            $('#pythonStatus').html('✅ Busca realizada com sucesso!');
            
            // Mostrar chunks
            if (response.chunks && response.chunks.length > 0) {
                let chunksHtml = '';
                response.chunks.forEach((chunk, index) => {
                    chunksHtml += `<div class="mb-2 p-2 border rounded">
                        <strong>Chunk ${index + 1}:</strong><br>
                        ${chunk.content.substring(0, 300)}...
                    </div>`;
                });
                $('#pythonChunks').html(chunksHtml);
            } else {
                $('#pythonChunks').html('<small class="text-muted">Nenhum chunk encontrado</small>');
            }
            
            // Mostrar resposta
            if (response.answer) {
                $('#pythonAnswer').html(response.answer);
            } else {
                $('#pythonAnswer').html('<small class="text-muted">Nenhuma resposta gerada</small>');
            }
            
            // Mostrar metadados
            $('#pythonMetadata').html(JSON.stringify(response.metadata, null, 2));
        })
        .fail(function(xhr) {
            $('#pythonStatus').html('❌ Erro na busca: ' + (xhr.responseJSON?.detail || 'Erro desconhecido'));
        });
}

function pythonHealthCheck() {
    $.get('/api/rag/health')
        .done(function(response) {
            showAlert('✅ RAG Python está funcionando!', 'success');
        })
        .fail(function() {
            showAlert('❌ RAG Python não está disponível', 'danger');
        });
}

function selectDocument(id) {
    $('#chatDocId').val(id);
    showAlert(`📄 Documento ${id} selecionado para consultas`, 'info');
}

function deleteDocument(id) {
    if (confirm('Tem certeza que deseja deletar este documento?')) {
        $.ajax({
            url: `/api/documents/${id}`,
            type: 'DELETE',
            success: function() {
                showAlert('✅ Documento deletado com sucesso', 'success');
                loadDocuments();
            },
            error: function(xhr) {
                showAlert('❌ Erro ao deletar: ' + (xhr.responseJSON?.detail || 'Erro desconhecido'), 'danger');
            }
        });
    }
}
</script>
{% endblock %}
