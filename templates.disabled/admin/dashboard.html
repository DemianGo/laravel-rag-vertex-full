{% extends "base.html" %}

{% block title %}Admin Dashboard - RAG System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 m-0">
            <i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard
        </h1>
        <div class="d-flex gap-2">
            <button id="btnRefreshStats" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-sync-alt me-1"></i>Atualizar
            </button>
            <a href="/admin/logout" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt me-1"></i>Logout
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Total de Usuários</h6>
                            <h3 class="mb-0" id="totalUsers">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Usuários Ativos</h6>
                            <h3 class="mb-0" id="activeUsers">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Total de Documentos</h6>
                            <h3 class="mb-0" id="totalDocuments">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Total de Chunks</h6>
                            <h3 class="mb-0" id="totalChunks">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-puzzle-piece fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                <i class="fas fa-chart-bar me-1"></i>Visão Geral
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#users" type="button">
                <i class="fas fa-users me-1"></i>Usuários
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documents" type="button">
                <i class="fas fa-file-alt me-1"></i>Documentos
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                <i class="fas fa-cog me-1"></i>Configurações
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-4 rounded-bottom">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview">
            <div class="row">
                <div class="col-md-6">
                    <h5>Usuários Recentes</h5>
                    <div id="recentUsers" class="console-box">
                        <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Documentos Recentes</h5>
                    <div id="recentDocuments" class="console-box">
                        <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-pane fade" id="users">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Gerenciar Usuários</h5>
                <div class="d-flex gap-2">
                    <input type="text" id="userSearch" class="form-control" placeholder="Buscar usuários..." style="width: 200px;">
                    <button id="btnSearchUsers" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
            </div>
            
            <div id="usersList" class="console-box">
                <i class="fas fa-spinner fa-spin me-2"></i>Carregando usuários...
            </div>
        </div>

        <!-- Documents Tab -->
        <div class="tab-pane fade" id="documents">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Gerenciar Documentos</h5>
                <div class="d-flex gap-2">
                    <input type="text" id="docSearch" class="form-control" placeholder="Buscar documentos..." style="width: 200px;">
                    <button id="btnSearchDocs" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
            </div>
            
            <div id="documentsList" class="console-box">
                <i class="fas fa-spinner fa-spin me-2"></i>Carregando documentos...
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings">
            <div class="row">
                <div class="col-md-6">
                    <h5>Configurações do Sistema</h5>
                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">URL Base da API</label>
                                <input type="text" class="form-control" value="http://localhost:8000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Limite de Tokens (Padrão)</label>
                                <input type="number" class="form-control" value="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Limite de Documentos (Padrão)</label>
                                <input type="number" class="form-control" value="1">
                            </div>
                            <button class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Salvar Configurações
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5>Ações do Sistema</h5>
                    <div class="card">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="clearCache()">
                                    <i class="fas fa-broom me-2"></i>Limpar Cache
                                </button>
                                <button class="btn btn-outline-warning" onclick="backupDatabase()">
                                    <i class="fas fa-download me-2"></i>Backup do Banco
                                </button>
                                <button class="btn btn-outline-info" onclick="systemHealth()">
                                    <i class="fas fa-heartbeat me-2"></i>Verificar Saúde
                                </button>
                                <button class="btn btn-outline-danger" onclick="restartServices()">
                                    <i class="fas fa-redo me-2"></i>Reiniciar Serviços
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadDashboardData();
    
    $('#btnRefreshStats').click(function() {
        loadDashboardData();
    });
    
    $('#btnSearchUsers').click(function() {
        searchUsers();
    });
    
    $('#btnSearchDocs').click(function() {
        searchDocuments();
    });
});

function loadDashboardData() {
    // Carregar estatísticas gerais
    $.get('/admin/dashboard')
        .done(function(response) {
            if (response.success) {
                const stats = response.stats;
                $('#totalUsers').text(stats.total_users);
                $('#activeUsers').text(stats.active_users);
                $('#totalDocuments').text(stats.total_documents);
                $('#totalChunks').text(stats.total_chunks);
                
                // Mostrar usuários recentes
                let usersHtml = '';
                if (response.recent_users && response.recent_users.length > 0) {
                    response.recent_users.forEach(function(user) {
                        usersHtml += `<div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>${user.name}</strong><br>
                                <small class="text-muted">${user.email}</small>
                            </div>
                            <span class="badge bg-${user.plan === 'free' ? 'secondary' : user.plan === 'pro' ? 'primary' : 'warning'}">${user.plan}</span>
                        </div>`;
                    });
                } else {
                    usersHtml = '<small class="text-muted">Nenhum usuário encontrado</small>';
                }
                $('#recentUsers').html(usersHtml);
                
                // Mostrar documentos recentes
                let docsHtml = '';
                if (response.recent_documents && response.recent_documents.length > 0) {
                    response.recent_documents.forEach(function(doc) {
                        docsHtml += `<div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>${doc.title}</strong><br>
                                <small class="text-muted">${doc.source}</small>
                            </div>
                            <small class="text-muted">${formatDate(doc.created_at)}</small>
                        </div>`;
                    });
                } else {
                    docsHtml = '<small class="text-muted">Nenhum documento encontrado</small>';
                }
                $('#recentDocuments').html(docsHtml);
            }
        })
        .fail(function() {
            showAlert('❌ Erro ao carregar dados do dashboard', 'danger');
        });
}

function searchUsers() {
    const search = $('#userSearch').val();
    
    $.get('/admin/users', { search: search })
        .done(function(response) {
            if (response.success) {
                let usersHtml = '<table class="table table-sm">';
                usersHtml += '<thead><tr><th>ID</th><th>Nome</th><th>Email</th><th>Plano</th><th>Criado</th><th>Ações</th></tr></thead><tbody>';
                
                response.users.forEach(function(user) {
                    usersHtml += `<tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge bg-${user.plan === 'free' ? 'secondary' : user.plan === 'pro' ? 'primary' : 'warning'}">${user.plan}</span></td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewUser(${user.id})">Ver</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="toggleAdmin(${user.id})">Admin</button>
                        </td>
                    </tr>`;
                });
                
                usersHtml += '</tbody></table>';
                $('#usersList').html(usersHtml);
            }
        })
        .fail(function() {
            showAlert('❌ Erro ao buscar usuários', 'danger');
        });
}

function searchDocuments() {
    const search = $('#docSearch').val();
    
    $.get('/admin/documents', { search: search })
        .done(function(response) {
            if (response.success) {
                let docsHtml = '<table class="table table-sm">';
                docsHtml += '<thead><tr><th>ID</th><th>Título</th><th>Fonte</th><th>Usuário</th><th>Criado</th><th>Ações</th></tr></thead><tbody>';
                
                response.documents.forEach(function(doc) {
                    docsHtml += `<tr>
                        <td>${doc.id}</td>
                        <td>${doc.title}</td>
                        <td>${doc.source}</td>
                        <td>${doc.user_name || 'N/A'}</td>
                        <td>${formatDate(doc.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDocument(${doc.id})">Ver</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument(${doc.id})">Deletar</button>
                        </td>
                    </tr>`;
                });
                
                docsHtml += '</tbody></table>';
                $('#documentsList').html(docsHtml);
            }
        })
        .fail(function() {
            showAlert('❌ Erro ao buscar documentos', 'danger');
        });
}

function viewUser(userId) {
    $.get(`/admin/users/${userId}`)
        .done(function(response) {
            if (response.success) {
                const user = response.user;
                const modalHtml = `
                    <div class="modal fade" id="userModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Usuário: ${user.name}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Informações Pessoais</h6>
                                            <p><strong>Nome:</strong> ${user.name}</p>
                                            <p><strong>Email:</strong> ${user.email}</p>
                                            <p><strong>Plano:</strong> <span class="badge bg-${user.plan === 'free' ? 'secondary' : user.plan === 'pro' ? 'primary' : 'warning'}">${user.plan}</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Estatísticas</h6>
                                            <p><strong>Tokens usados:</strong> ${user.tokens_used || 0}</p>
                                            <p><strong>Tokens limite:</strong> ${user.tokens_limit || 0}</p>
                                            <p><strong>Documentos:</strong> ${user.documents_used || 0}</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <h6>Documentos do Usuário</h6>
                                        <div class="console-box" style="max-height: 200px; overflow-y: auto;">
                                            ${response.documents.map(doc => `<div class="mb-2"><strong>${doc.title}</strong><br><small class="text-muted">${doc.source} - ${formatDate(doc.created_at)}</small></div>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(modalHtml);
                $('#userModal').modal('show');
                $('#userModal').on('hidden.bs.modal', function() {
                    $(this).remove();
                });
            }
        })
        .fail(function() {
            showAlert('❌ Erro ao carregar usuário', 'danger');
        });
}

function toggleAdmin(userId) {
    if (confirm('Tem certeza que deseja alterar o status de admin deste usuário?')) {
        $.patch(`/admin/users/${userId}/toggle-admin`)
            .done(function(response) {
                if (response.success) {
                    showAlert('✅ Status de admin alterado com sucesso!', 'success');
                    searchUsers();
                }
            })
            .fail(function() {
                showAlert('❌ Erro ao alterar status de admin', 'danger');
            });
    }
}

function viewDocument(docId) {
    $.get(`/admin/documents/${docId}`)
        .done(function(response) {
            if (response.success) {
                const doc = response.document;
                const modalHtml = `
                    <div class="modal fade" id="docModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Documento: ${doc.title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Informações do Documento</h6>
                                            <p><strong>Título:</strong> ${doc.title}</p>
                                            <p><strong>Fonte:</strong> ${doc.source}</p>
                                            <p><strong>Usuário:</strong> ${doc.user_name || 'N/A'}</p>
                                            <p><strong>Criado:</strong> ${formatDate(doc.created_at)}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Chunks (${response.chunks.length})</h6>
                                            <div class="console-box" style="max-height: 300px; overflow-y: auto;">
                                                ${response.chunks.map(chunk => `<div class="mb-2"><strong>Chunk ${chunk.chunk_index}:</strong><br>${chunk.content.substring(0, 200)}...</div>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(modalHtml);
                $('#docModal').modal('show');
                $('#docModal').on('hidden.bs.modal', function() {
                    $(this).remove();
                });
            }
        })
        .fail(function() {
            showAlert('❌ Erro ao carregar documento', 'danger');
        });
}

function deleteDocument(docId) {
    if (confirm('Tem certeza que deseja deletar este documento? Esta ação não pode ser desfeita.')) {
        $.ajax({
            url: `/admin/documents/${docId}`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert('✅ Documento deletado com sucesso!', 'success');
                    searchDocuments();
                }
            },
            error: function() {
                showAlert('❌ Erro ao deletar documento', 'danger');
            }
        });
    }
}

function clearCache() {
    if (confirm('Tem certeza que deseja limpar o cache?')) {
        showAlert('✅ Cache limpo com sucesso!', 'success');
    }
}

function backupDatabase() {
    showAlert('✅ Backup iniciado!', 'info');
}

function systemHealth() {
    $.get('/api/health')
        .done(function(response) {
            showAlert('✅ Sistema funcionando normalmente!', 'success');
        })
        .fail(function() {
            showAlert('❌ Problemas detectados no sistema', 'danger');
        });
}

function restartServices() {
    if (confirm('Tem certeza que deseja reiniciar os serviços?')) {
        showAlert('✅ Serviços reiniciados!', 'success');
    }
}
</script>
{% endblock %}
