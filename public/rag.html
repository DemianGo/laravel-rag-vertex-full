<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RAG Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">RAG Demo</h1>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- Ingest -->
      <section class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-3">Ingest (gravar documento)</h2>
        <label class="block text-sm mb-1">Tenant</label>
        <input id="ing-tenant" class="w-full border rounded px-3 py-2 mb-2" value="demo"/>

        <label class="block text-sm mb-1">Título</label>
        <input id="ing-title" class="w-full border rounded px-3 py-2 mb-2" value="Política de Suporte"/>

        <label class="block text-sm mb-1">Texto</label>
        <textarea id="ing-text" class="w-full border rounded px-3 py-2 mb-3" rows="6">Nosso suporte funciona de segunda a sexta, das 9h às 18h. Respostas priorizam clientes enterprise. SLA padrão 24 horas.</textarea>

        <button id="ing-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Ingestir</button>
        <pre id="ing-out" class="mt-3 text-xs bg-slate-100 p-3 rounded overflow-auto"></pre>
      </section>

      <!-- Query -->
      <section class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-3">Query (busca vetorial)</h2>
        <label class="block text-sm mb-1">Tenant</label>
        <input id="q-tenant" class="w-full border rounded px-3 py-2 mb-2" value="demo"/>

        <label class="block text-sm mb-1">Pergunta</label>
        <input id="q-text" class="w-full border rounded px-3 py-2 mb-2" value="Qual é o horário do suporte?"/>

        <label class="block text-sm mb-1">top_k</label>
        <input id="q-topk" type="number" class="w-full border rounded px-3 py-2 mb-3" value="3"/>

        <button id="q-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2">Buscar</button>
        <div id="q-list" class="mt-4 space-y-3"></div>
        <pre id="q-out" class="mt-3 text-xs bg-slate-100 p-3 rounded overflow-auto"></pre>
      </section>
    </div>
  </div>

  <script>
    const base = window.location.origin;

    async function postJSON(url, body) {
      const r = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      const txt = await r.text();
      try { return {ok: r.ok, data: JSON.parse(txt), raw: txt}; }
      catch { return {ok: r.ok, data: null, raw: txt}; }
    }

    document.getElementById("ing-btn").addEventListener("click", async () => {
      const payload = {
        tenant: document.getElementById("ing-tenant").value.trim(),
        title:  document.getElementById("ing-title").value.trim(),
        text:   document.getElementById("ing-text").value.trim(),
      };
      const res = await postJSON(`${base}/api/rag/ingest`, payload);
      document.getElementById("ing-out").textContent = res.raw;
    });

    document.getElementById("q-btn").addEventListener("click", async () => {
      const payload = {
        tenant: document.getElementById("q-tenant").value.trim(),
        query:  document.getElementById("q-text").value.trim(),
        top_k:  Number(document.getElementById("q-topk").value || 3),
      };
      const res = await postJSON(`${base}/api/rag/query`, payload);
      const list = document.getElementById("q-list");
      list.innerHTML = "";
      if (res.data && res.data.ok && Array.isArray(res.data.hits)) {
        res.data.hits.forEach((h) => {
          const el = document.createElement("div");
          el.className = "border rounded p-3 bg-white";
          el.innerHTML = \`
            <div class="text-xs text-slate-500">score: \${(h.score ?? 0).toFixed(3)}</div>
            <div class="mt-1 whitespace-pre-wrap">\${h.content || ""}</div>
          \`;
          list.appendChild(el);
        });
      }
      document.getElementById("q-out").textContent = res.raw;
    });
  </script>
</body>
</html>
