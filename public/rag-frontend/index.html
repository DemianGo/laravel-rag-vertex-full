<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RAG Console ‚Äî PRO (Light)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <!-- File Validator (independent module) -->
  <script src="file-validator.js"></script>
  <style>
    :root {
      --console-bg: #f8f9fa;
      --console-border: #dee2e6;
      --console-text: #212529;
      --zone-border: #cbd5e1;
      --zone-bg: #ffffff;
      --zone-hover: #eef2ff;
    }
    body { background:#fff; color:#212529; padding-bottom: 300px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .card { border-radius: 1rem; }
    .btn { border-radius: .75rem; }
    /* Debug console (fixo, claro) */
    .fixed-console {
      position: fixed; left:0; right:0; bottom:0; z-index:1030;
      background: var(--console-bg); border-top: 1px solid var(--console-border); color: var(--console-text);
      max-height: 260px; overflow: hidden;
      box-shadow: 0 -6px 30px rgba(0,0,0,.06);
    }
    .console-body { max-height: 190px; overflow: auto; }
    .badge-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .pointer { cursor: pointer; }
    /* Upload zone (drag & drop) */
    .dropzone {
      border: 2px dashed var(--zone-border);
      background: var(--zone-bg);
      border-radius: 14px;
      padding: 20px;
      transition: background .2s, border-color .2s;
      text-align: center;
    }
    .dropzone.dragover { background: var(--zone-hover); border-color: #94a3b8; }
    .dz-icon { font-size: 32px; line-height: 1; }
    .dz-sub { color:#6c757d; }
    .file-chip {
      border: 1px solid #e9ecef; border-radius: 999px; padding: 4px 10px; display: inline-flex; gap:8px; align-items:center; margin: 4px 6px 0 0;
      background: #fff;
    }
    .file-chip .x { cursor:pointer; font-weight:bold; color:#dc3545; }
    .progress { height: 6px; border-radius: 999px; }
    .table-log td, .table-log th { padding: .25rem .5rem; }
    .bg-soft { background:#f6f7fb; }
    code { background: #f8f9fa; padding: .1rem .35rem; border-radius: .25rem; }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 m-0">RAG Console ‚Äî <small class="text-secondary">Simplificado</small></h1>
      <div class="d-flex gap-2">
        <button id="btnHealth" class="btn btn-outline-success btn-sm">ü©∫ Health</button>
        <button id="btnConfig" class="btn btn-outline-dark btn-sm">‚öôÔ∏è Configurar</button>
      </div>
    </div>

    <div class="alert alert-light border bg-soft" role="alert">
      Base atual: <span class="mono" id="baseUrlLabel">(mesma origem)</span> ¬∑
      Modelo padr√£o: <span class="mono" id="modelLabel">gemini-2.5-flash</span> ¬∑
      Endpoints: <code>/api/rag/ingest</code>, <code>/api/rag/query</code>, <code>/api/rag/answer</code>, <code>/api/vertex/generate</code>.
    </div>

    <!-- Abas -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ing" type="button">Ingest</button></li>
      <!-- DESATIVADAS - CEN√ÅRIO MINIMALISTA -->
      <li class="nav-item" style="display:none;"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#query" type="button">Query</button></li>
      <li class="nav-item" style="display:none;"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#answer" type="button">Answer (RAG+LLM)</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#python" type="button">Python RAG</button></li>
      <li class="nav-item" style="display:none;"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gen" type="button">Vertex Generate</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#metrics" type="button">M√©tricas</button></li>
      <!-- ADMIN E CALCULADORA - Ser√£o movidas para painel admin separado (futuro) -->
      <li class="nav-item" style="display:none;"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin" type="button">Admin</button></li>
      <li class="nav-item" style="display:none;"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cost" type="button">Calculadora de Custos</button></li>
    </ul>

    <div class="tab-content border border-top-0 p-3 rounded-bottom">

      <!-- INGEST -->
      <div class="tab-pane fade show active" id="ing">
        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="mb-2">
              <label class="form-label">Fonte (URL opcional)</label>
              <input id="ingUrl" class="form-control" placeholder="https://exemplo.com/artigo (opcional)">
            </div>
            <div class="mb-2">
              <label class="form-label">Texto</label>
              <textarea id="ingText" class="form-control" rows="6" placeholder="Cole aqui um texto para ingest√£o"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Arquivos (PDF/Doc/etc.) <small class="text-muted">‚Ä¢ M√°x: 5 arquivos, 500MB, 5.000 p√°ginas cada</small></label>
              <div class="dropzone" id="dzIngest">
                <div class="dz-icon">üìÑ</div>
                <div class="dz-sub">Arraste e solte arquivos aqui ou <label class="text-primary" style="text-decoration:underline; cursor:pointer;"><input id="ingFiles" type="file" multiple hidden> clique para selecionar</label></div>
                <div id="ingFileList" class="mt-2"></div>
              </div>
              <!-- File validation info (populated by file-validator.js) -->
              <div id="fileValidationInfo" class="mt-2"></div>
            </div>
            <div class="mb-2">
              <label class="form-label">Metadata (JSON opcional)</label>
              <textarea id="ingMeta" class="form-control mono" rows="3" placeholder='{"source":"manual","tags":["demo"]}'></textarea>
            </div>
            <div class="d-grid"><button id="btnIngest" class="btn btn-primary">Enviar Ingest√£o</button></div>
            <div class="mt-2 d-none" id="ingProgressWrap">
              <div class="progress"><div class="progress-bar" id="ingProgress" role="progressbar" style="width:0%"></div></div>
              <small class="text-muted" id="ingProgressText"></small>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <h6>Resposta</h6>
            <pre id="ingestOut" class="mono p-3 border rounded bg-soft"></pre>
          </div>
        </div>
      </div>

      <!-- QUERY -->
      <div class="tab-pane fade" id="query">
        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="mb-2">
              <label class="form-label">Pergunta</label>
              <textarea id="qText" class="form-control" rows="6" placeholder="Ex.: O que o documento fala sobre X?"></textarea>
            </div>
            <div class="row gx-2">
              <div class="col-4"><label class="form-label">Top K</label><input id="qTopK" type="number" class="form-control" placeholder="ex.: 4"></div>
              <div class="col-4"><label class="form-label">Temperature</label><input id="qTemp" type="number" step="0.01" class="form-control" placeholder="ex.: 0.2"></div>
              <div class="col-4"><label class="form-label">Max Tokens</label><input id="qMaxTokens" type="number" class="form-control" placeholder="ex.: 512"></div>
            </div>
            <div class="d-grid mt-2"><button id="btnQuery" class="btn btn-success">Consultar</button></div>
          </div>
          <div class="col-12 col-xl-6">
            <h6>Resposta</h6>
            <pre id="queryOut" class="mono p-3 border rounded bg-soft"></pre>
          </div>
        </div>
      </div>

      <!-- ANSWER -->
      <div class="tab-pane fade" id="answer">
        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="mb-2">
              <label class="form-label">Document ID</label>
              <div class="input-group">
                <select id="answerDocSelect" class="form-select">
                  <option value="">Carregando documentos...</option>
                </select>
                <input id="aDocId" type="number" class="form-control" placeholder="ID do documento" value="125" style="display:none;">
                <button id="toggleAnswerDocInput" class="btn btn-outline-secondary" type="button" title="Alternar entre select e input manual">
                  üî¢
                </button>
                <button id="btnLoadLatest" class="btn btn-outline-secondary" type="button">√öltimo</button>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Pergunta</label>
              <textarea id="aText" class="form-control" rows="6" placeholder="Pergunta para RAG + LLM"></textarea>
            </div>
            <div class="row gx-2">
              <div class="col-4"><label class="form-label">Top K</label><input id="aTopK" type="number" class="form-control" placeholder="ex.: 3"></div>
              <div class="col-8"><label class="form-label">Modelo (override opcional)</label><input id="aModel" class="form-control" placeholder="ex.: gemini-2.5-flash"></div>
            </div>
            <div class="d-grid mt-2"><button id="btnAnswer" class="btn btn-warning">Gerar Resposta</button></div>
          </div>
          <div class="col-12 col-xl-6">
            <h6>Resposta</h6>
            <pre id="answerOut" class="mono p-3 border rounded bg-soft"></pre>
          </div>
        </div>
      </div>

      <!-- PYTHON RAG -->
      <div class="tab-pane fade" id="python">
        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <!-- MODO SIMPLES (sempre vis√≠vel) -->
            <div class="mb-3">
              <label class="form-label fw-bold">üìÑ Escolher Documento</label>
              <div class="input-group">
                <select id="pythonDocSelect" class="form-select form-select-lg">
                  <option value="">Carregando documentos...</option>
                </select>
                <input id="pythonDocId" class="form-control form-control-lg" type="number" placeholder="Ou digite ID manual" style="display:none;">
                <button id="toggleDocInput" class="btn btn-outline-secondary" type="button" title="Alternar entre select e input manual">
                  üî¢
                </button>
              </div>
              <small class="form-text text-muted">Selecione um documento da lista ou digite o ID manualmente</small>
            </div>
            
            <div id="pythonSuggestedQuestions" class="mb-3" style="display:none;">
              <label class="form-label">üí° Perguntas Sugeridas:</label>
              <div id="pythonSuggestedList" class="d-flex flex-wrap gap-2"></div>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">üí¨ Sua Pergunta</label>
              <textarea id="pythonQuery" class="form-control" rows="3" placeholder="Digite sua pergunta aqui... Exemplo: 'Quais os certificados?'"></textarea>
            </div>
            
            <div class="mb-3">
              <div class="form-check">
                <input id="pythonUseSmartMode" class="form-check-input" type="checkbox" checked>
                <label class="form-check-label fw-bold">üß† Modo Inteligente (Recomendado)</label>
                <br><small class="form-text text-muted">Sistema decide automaticamente a melhor estrat√©gia</small>
              </div>
            </div>
            
            <div class="d-grid gap-2 mb-3">
              <button id="pythonSearchBtn" class="btn btn-primary btn-lg">üîç Buscar</button>
            </div>
            
            <!-- TOGGLE PARA MODO AVAN√áADO -->
            <div class="mb-3">
              <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#pythonAdvancedOptions">
                ‚öôÔ∏è Op√ß√µes Avan√ßadas (opcional)
              </button>
            </div>
            
            <!-- CONTROLES AVAN√áADOS (colaps√°vel) -->
            <div class="collapse" id="pythonAdvancedOptions">
              <div class="card card-body bg-light">
                <h6 class="text-muted">Controles T√©cnicos</h6>
                
                <div class="row gx-2 mb-2">
                  <div class="col-6">
                    <label class="form-label small">Top-K</label>
                    <input id="pythonTopK" class="form-control form-control-sm" type="number" value="5" min="1" max="20">
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Threshold</label>
                    <input id="pythonThreshold" class="form-control form-control-sm" type="number" value="0.3" min="0.05" max="1.0" step="0.05">
                  </div>
                </div>
                
                <div class="mb-2">
                  <div class="form-check">
                    <input id="pythonIncludeAnswer" class="form-check-input" type="checkbox" checked>
                    <label class="form-check-label small">Incluir resposta LLM</label>
                  </div>
                </div>
                
                <div class="mb-2">
                  <div class="form-check">
                    <input id="pythonUseFullDocument" class="form-check-input" type="checkbox">
                    <label class="form-check-label small">Usar Documento Completo</label>
                  </div>
                </div>
                
                <div class="mb-2">
                  <label class="form-label small">Strictness (0-3)</label>
                  <select id="pythonStrictness" class="form-select form-select-sm">
                    <option value="0">0 - Muito Permissivo</option>
                    <option value="1">1 - Permissivo</option>
                    <option value="2" selected>2 - Moderado (Padr√£o)</option>
                    <option value="3">3 - Rigoroso (Sem LLM)</option>
                  </select>
                </div>
                
                <div class="row gx-2 mb-2">
                  <div class="col-6">
                    <label class="form-label small">Modo</label>
                    <select id="pythonMode" class="form-select form-select-sm">
                      <option value="auto" selected>Auto (Detecta)</option>
                      <option value="direct">Direct</option>
                      <option value="summary">Summary</option>
                      <option value="quote">Quote</option>
                      <option value="list">List</option>
                      <option value="table">Table</option>
                      <option value="document_full">Document Full</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Formato</label>
                    <select id="pythonFormat" class="form-select form-select-sm">
                      <option value="plain" selected>Plain</option>
                      <option value="markdown">Markdown</option>
                      <option value="html">HTML</option>
                    </select>
                  </div>
                </div>
                
                <div class="row gx-2 mb-2">
                  <div class="col-6">
                    <label class="form-label small">Comprimento</label>
                    <select id="pythonLength" class="form-select form-select-sm">
                      <option value="auto" selected>Auto</option>
                      <option value="short">Short</option>
                      <option value="medium">Medium</option>
                      <option value="long">Long</option>
                      <option value="xl">XL</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Cita√ß√µes (0-10)</label>
                    <input id="pythonCitations" class="form-control form-control-sm" type="number" value="0" min="0" max="10">
                  </div>
                </div>
                
                <div class="d-flex gap-2 mt-3">
                  <button id="pythonCompareBtn" class="btn btn-outline-secondary btn-sm">‚öñÔ∏è Comparar PHP vs Python</button>
                  <button id="pythonHealthBtn" class="btn btn-outline-info btn-sm">üè• Health Check</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="mb-2">
              <label class="form-label">Resultados Python RAG</label>
              <div id="pythonStatus" class="alert alert-info">Pronto para busca...</div>
            </div>
            <div class="mb-2">
              <label class="form-label">Chunks Encontrados</label>
              <div id="pythonChunks" class="border rounded p-2 bg-light" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="mb-2">
              <label class="form-label">Resposta LLM</label>
              <div id="pythonAnswer" class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;"></div>
              
              <!-- FEEDBACK BUTTONS -->
              <div id="feedbackSection" class="mt-2" style="display:none;">
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted">Esta resposta foi √∫til?</small>
                  <button id="feedbackThumbsUp" class="btn btn-sm btn-outline-success" title="Resposta √∫til">
                    üëç √ötil
                  </button>
                  <button id="feedbackThumbsDown" class="btn btn-sm btn-outline-danger" title="Resposta n√£o √∫til">
                    üëé N√£o √∫til
                  </button>
                  <span id="feedbackStatus" class="small text-success" style="display:none;"></span>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Metadados</label>
              <pre id="pythonMetadata" class="mono p-2 border rounded bg-soft small"></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- GENERATE -->
      <div class="tab-pane fade" id="gen">
        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="mb-2">
              <label class="form-label">Prompt</label>
              <textarea id="gPrompt" class="form-control" rows="6" placeholder="Prompt para Vertex"></textarea>
            </div>
            <div class="row gx-2">
              <div class="col-6"><label class="form-label">Modelo</label><input id="gModel" class="form-control" placeholder="gemini-2.5-flash (padr√£o)"></div>
              <div class="col-6"><label class="form-label">Location</label><input id="gLoc" class="form-control" placeholder="global (padr√£o)"></div>
            </div>
            <div class="mb-2">
              <label class="form-label">Arquivos (imagens/otros para o prompt)</label>
              <div class="dropzone" id="dzGen">
                <div class="dz-icon">üñºÔ∏è</div>
                <div class="dz-sub">Arraste e solte aqui ou <label class="text-primary" style="text-decoration:underline; cursor:pointer;"><input id="gFiles" type="file" multiple hidden> clique para selecionar</label></div>
                <div id="gFileList" class="mt-2"></div>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button id="btnGenGET" class="btn btn-outline-info">GET /api/vertex/generate</button>
              <button id="btnGenPOST" class="btn btn-info">POST /api/vertex/generate</button>
            </div>
            <div class="mt-2 d-none" id="genProgressWrap">
              <div class="progress"><div class="progress-bar" id="genProgress" role="progressbar" style="width:0%"></div></div>
              <small class="text-muted" id="genProgressText"></small>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <h6>Resposta</h6>
            <pre id="genOut" class="mono p-3 border rounded bg-soft"></pre>
          </div>
        </div>
      </div>

      <!-- M√âTRICAS -->
      <div class="tab-pane fade" id="metrics">
        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <h6>M√©tricas do Sistema</h6>
            <div class="d-grid gap-2">
              <button id="btnMetrics" class="btn btn-outline-primary">Carregar M√©tricas</button>
              <button id="btnCacheStats" class="btn btn-outline-info">Estat√≠sticas de Cache</button>
              <button id="btnEmbeddingsStats" class="btn btn-outline-success">Estat√≠sticas de Embeddings</button>
            </div>
            
            <div class="mt-3">
              <h6>üìä Feedback & Analytics</h6>
              <div class="d-grid gap-2">
                <button id="btnFeedbackStats" class="btn btn-outline-primary">üìà Estat√≠sticas de Feedback</button>
                <button id="btnRecentFeedbacks" class="btn btn-outline-secondary">üìù Feedbacks Recentes</button>
              </div>
            </div>
            
            <div class="mt-3">
              <h6>Cache Management</h6>
              <div class="d-grid gap-2">
                <button id="btnClearCache" class="btn btn-outline-warning">Limpar Cache</button>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <h6>Resultado</h6>
            <pre id="metricsOut" class="mono p-3 border rounded bg-soft">Clique em um bot√£o para carregar m√©tricas...</pre>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="tab-pane fade" id="admin">
        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <h6>Administra√ß√£o</h6>
            <div class="mb-3">
              <label class="form-label">Document ID para Reprocessar</label>
              <input id="adminDocId" type="number" class="form-control" placeholder="ID do documento">
            </div>
            <div class="d-grid gap-2">
              <button id="btnReprocessDoc" class="btn btn-outline-warning">Reprocessar Documento</button>
              <button id="btnBatchIngest" class="btn btn-outline-info">Upload em Lote</button>
              <button id="btnQualityIngest" class="btn btn-outline-success">Upload com Qualidade</button>
              <button id="btnPreview" class="btn btn-outline-secondary">Preview Documento</button>
            </div>
            <div class="mt-3">
              <h6>Debug</h6>
              <div class="d-grid gap-2">
                <button id="btnDebugEcho" class="btn btn-outline-dark">Debug Echo</button>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <h6>Resultado</h6>
            <pre id="adminOut" class="mono p-3 border rounded bg-soft">Selecione uma a√ß√£o administrativa...</pre>
          </div>
        </div>
      </div>

      <!-- COST CALCULATOR -->
      <div class="tab-pane fade" id="cost">
        <div class="row g-3">
          <div class="col-12 col-xl-8">
            <div class="alert alert-light border">
              <div><strong>Tabela (USD)</strong> baseada na p√°gina oficial de pre√ßos da Vertex AI. Valores por <em>1M tokens</em> (ou <em>1M caracteres</em> quando indicado).</div>
              <div class="small text-secondary">√öltima verifica√ß√£o: set/2025. Confirme sempre no site oficial.</div>
            </div>
            <label class="form-label">Modelo</label>
            <select id="ccModel" class="form-select">
              <option value="gemini-2.5-flash">gemini-2.5-flash</option>
              <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
              <option value="gemini-2.5-pro">gemini-2.5-pro</option>
              <option value="gemini-embedding-001">gemini-embedding-001 (tokens)</option>
              <option value="text-embedding-004">text-embedding-004 (caracteres)</option>
            </select>
            <div class="row gx-2 mt-2">
              <div class="col-12 col-md-6"><label class="form-label">Entrada (tokens ou caracteres)</label><input id="ccIn" type="number" class="form-control" placeholder="ex.: 2000"></div>
              <div class="col-12 col-md-6"><label class="form-label">Sa√≠da (tokens, quando aplic√°vel)</label><input id="ccOut" type="number" class="form-control" placeholder="ex.: 800"></div>
            </div>
            <div class="form-check mt-2"><input class="form-check-input" type="checkbox" id="ccLongCtx"><label class="form-check-label" for="ccLongCtx">Contexto &gt; 200K tokens</label></div>
            <div class="form-text">Regra pr√°tica: ~4 caracteres ‚âà 1 token.</div>
            <button id="btnCalc" class="btn btn-outline-dark mt-2">Calcular</button>
            <h6 class="mt-3">Estimativa</h6><pre id="ccOutArea" class="mono p-3 border rounded bg-soft"></pre>
          </div>
          <div class="col-12 col-xl-4">
            <div class="card">
              <div class="card-body">
                <h6>Pre√ßos (por 1M)</h6>
                <div class="small">
                  <ul class="mb-2">
                    <li><span class="mono">gemini-2.5-flash</span>: in $0.30 ¬∑ out $2.50</li>
                    <li><span class="mono">gemini-2.5-flash-lite</span>: in $0.10 ¬∑ out $0.40</li>
                    <li><span class="mono">gemini-2.5-pro</span>: in $1.25 ¬∑ out $10</li>
                    <li><span class="mono">gemini-embedding-001</span>: in $0.15 (tokens)</li>
                    <li><span class="mono">text-embedding-004</span>: $0.000025 / 1k chars (~$0.025 / 1M chars)</li>
                  </ul>
                  <div class="text-secondary">Fonte: Vertex AI pricing.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /tab-content -->
  </div><!-- /container -->

  <!-- Modal Config -->
  <div class="modal" tabindex="-1" id="cfgModal"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Configura√ß√£o</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="mb-2"><label class="form-label">Base URL da API</label><input id="cfgBaseUrl" class="form-control" placeholder="ex.: http://localhost:8000 (vazio = mesma origem)"></div>
      <div class="mb-2"><label class="form-label">Modelo padr√£o</label><input id="cfgModel" class="form-control" placeholder="gemini-2.5-flash"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button><button class="btn btn-primary" id="cfgSave">Salvar</button></div>
  </div></div></div>

  <!-- Debug Console -->
  <div class="fixed-console">
    <div class="p-2 d-flex justify-content-between align-items-center">
      <strong>Debug Console</strong>
      <div class="d-flex gap-2 align-items-center">
        <span id="healthDot" class="badge-dot bg-secondary"></span>
        <small id="healthText" class="text-muted">Sem teste</small>
        <button id="btnClearLog" class="btn btn-sm btn-outline-dark">Limpar</button>
        <button id="btnToggleConsole" class="btn btn-sm btn-dark">Ocultar</button>
      </div>
    </div>
    <div class="console-body p-2" id="consoleBody">
      <table class="table table-striped table-bordered table-log mb-0">
        <thead class="table-light"><tr><th>#</th><th>M√©todo</th><th>URL</th><th>Status</th><th>ms</th><th>Ver</th></tr></thead>
        <tbody id="logTable"></tbody>
      </table>
      <div id="reqDetail" class="mt-2 d-none">
        <hr class="border-secondary">
        <div class="d-flex justify-content-between align-items-center">
          <h6>Detalhe</h6><button id="btnCopyCurl" class="btn btn-sm btn-outline-primary">Copiar cURL</button>
        </div>
        <pre id="detailPre" class="mono p-3 border rounded bg-soft"></pre>
      </div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const LS = { baseUrl:"ragpro_base_url", model:"ragpro_model" };
    function getBaseUrl(){ return localStorage.getItem(LS.baseUrl)||""; }
    function setBaseUrl(v){ localStorage.setItem(LS.baseUrl, v||""); updateLabels(); }
    function getModel(){ return localStorage.getItem(LS.model)||"gemini-2.5-flash"; }
    function setModel(v){ localStorage.setItem(LS.model, v||"gemini-2.5-flash"); updateLabels(); }
    function updateLabels(){ document.getElementById("baseUrlLabel").textContent=getBaseUrl()||"(mesma origem)"; document.getElementById("modelLabel").textContent=getModel(); }
    updateLabels();

    // ======= PRICING =======
    const PRICING = {
      "gemini-2.5-flash": { unit:"tokens", input_per_1M:{short:0.30,long:0.30}, output_per_1M:{short:2.50,long:2.50} },
      "gemini-2.5-flash-lite": { unit:"tokens", input_per_1M:{short:0.10,long:0.10}, output_per_1M:{short:0.40,long:0.40} },
      "gemini-2.5-pro": { unit:"tokens", input_per_1M:{short:1.25,long:2.50}, output_per_1M:{short:10.00,long:15.00} },
      "gemini-embedding-001": { unit:"tokens", input_per_1M:{short:0.15,long:0.15}, output_per_1M:null },
      "text-embedding-004": { unit:"chars", input_per_1M_chars:0.025, output_per_1M_chars:0 }
    };

    // ======= DEBUG CONSOLE =======
    let LOG=[], LOGSEQ=1;
    function pushLog(entry){
      LOG.push(entry);
      const tr=document.createElement("tr");
      tr.className="pointer";
      tr.addEventListener("click",()=>showDetail(entry));
      tr.innerHTML=`<td>${entry.id}</td><td>${entry.method}</td><td class="mono">${entry.url}</td><td>${entry.status}</td><td>${entry.ms}</td><td>‚ñ∂</td>`;
      document.getElementById("logTable").prepend(tr);
    }
    function showDetail(entry){
      const pre=document.getElementById("detailPre");
      pre.textContent=JSON.stringify(entry,null,2);
      document.getElementById("reqDetail").classList.remove("d-none");
      document.getElementById("btnCopyCurl").onclick=()=>{
        const curl=buildCurl(entry); navigator.clipboard.writeText(curl);
      };
    }
    function buildCurl(e){
      const headers = e.requestHeaders || {"Content-Type":"application/json"};
      const hdr = Object.entries(headers).map(([k,v])=>`-H '${k}: ${v}'`).join(" ");
      let data = "";
      if (headers["Content-Type"] && headers["Content-Type"].includes("multipart/form-data")) {
        data = "# multipart form-data (veja os campos abaixo no detalhe do request)";
      } else if (e.requestBody) {
        data = `--data '${JSON.stringify(e.requestBody)}'`;
      }
      return `curl -s -X ${e.method} ${hdr} ${data} '${e.fullUrl}'`;
    }
    document.getElementById("btnClearLog").addEventListener("click",()=>{ LOG=[]; document.getElementById("logTable").innerHTML=""; document.getElementById("reqDetail").classList.add("d-none"); });
    document.getElementById("btnToggleConsole").addEventListener("click",()=>{ const el=document.getElementById("consoleBody"); el.style.display=(el.style.display==="none")?"block":"none"; });

    function pretty(el,data){ try{ el.textContent=JSON.stringify(data,null,2);}catch{ el.textContent=String(data);} }
    function buildUrl(path){ const base=getBaseUrl().replace(/\/$/,""); return base? base+path : path; }

    async function doFetchJSON(method,path,bodyObj){
      const url=buildUrl(path), t0=performance.now(); let status=-1, respHeaders={}, respJson=null, err=null;
      try{
        const res=await fetch(url,{ method, headers:{"Content-Type":"application/json"}, body: bodyObj? JSON.stringify(bodyObj): undefined });
        status=res.status; res.headers.forEach((v,k)=>{respHeaders[k]=v}); respJson=await res.json().catch(()=>({status:res.status,text:"Resposta n√£o-JSON"})); return respJson;
      }catch(e){ err=e; throw e; }
      finally{
        const t1=performance.now();
        pushLog({ id:LOGSEQ++, method, url:path, fullUrl:url, requestHeaders:{"Content-Type":"application/json"}, requestBody:bodyObj||null, status, ms:Math.round(t1-t0), responseHeaders:respHeaders, response:respJson, error: err? String(err): null });
      }
    }

    function xhrMultipart(method, path, formData, onProgress){
      return new Promise((resolve,reject)=>{
        const url = buildUrl(path);
        const xhr = new XMLHttpRequest();
        const t0 = performance.now();
        xhr.open(method, url, true);
        // progress total
        xhr.upload.addEventListener("progress", (e)=>{
          if(e.lengthComputable && onProgress){ onProgress(e.loaded, e.total); }
        });
        xhr.onreadystatechange = ()=>{
          if (xhr.readyState === 4){
            const ms = Math.round(performance.now() - t0);
            let respJson=null;
            try{ respJson = JSON.parse(xhr.responseText); } catch(_){ respJson = {status:xhr.status, text:"Resposta n√£o-JSON"}; }
            pushLog({
              id:LOGSEQ++,
              method, url:path, fullUrl:url,
              requestHeaders: {"Content-Type":"multipart/form-data"},
              requestBody: null,
              status: xhr.status, ms,
              responseHeaders: {"content-type": xhr.getResponseHeader("content-type")||""},
              response: respJson,
              error: (xhr.status>=200 && xhr.status<300) ? null : `HTTP ${xhr.status}`
            });
            if (xhr.status>=200 && xhr.status<300) resolve(respJson); else reject(new Error("HTTP "+xhr.status));
          }
        };
        xhr.onerror = ()=>reject(new Error("Erro de rede"));
        xhr.send(formData);
      });
    }

    // ======= HEALTH =======
    document.getElementById("btnHealth").addEventListener("click", async ()=>{
      const dot=document.getElementById("healthDot"), txt=document.getElementById("healthText");
      dot.className="badge-dot bg-secondary"; txt.textContent="testando...";
      try{
        const data=await doFetchJSON("GET","/api/health");
        if (data && (data.ok || data.status==="ok")) { dot.className="badge-dot bg-success"; txt.textContent="OK"; }
        else { dot.className="badge-dot bg-warning"; txt.textContent="Falha l√≥gica"; }
      } catch {
        dot.className="badge-dot bg-danger"; txt.textContent="Erro de rede";
      }
    });

    // ======= CONFIG MODAL =======
    document.getElementById("btnConfig").addEventListener("click", ()=>{
      document.getElementById("cfgBaseUrl").value=getBaseUrl();
      document.getElementById("cfgModel").value=getModel();
      new bootstrap.Modal(document.getElementById("cfgModal")).show();
    });
    document.getElementById("cfgSave").addEventListener("click", ()=>{
      setBaseUrl(document.getElementById("cfgBaseUrl").value.trim());
      setModel(document.getElementById("cfgModel").value.trim());
      bootstrap.Modal.getInstance(document.getElementById("cfgModal")).hide();
    });

    // ======= UPLOAD WIDGETS =======
    function initDropzone(zoneId, inputId, listId){
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      let files = [];

      function render(){
        list.innerHTML = "";
        files.forEach((f, idx)=>{
          const chip = document.createElement("span");
          chip.className = "file-chip";
          chip.innerHTML = `<span class="mono">${f.name}</span><span class="text-muted small">${(f.size/1024).toFixed(1)} KB</span><span class="x" data-idx="${idx}">√ó</span>`;
          list.appendChild(chip);
        });
        list.querySelectorAll(".x").forEach(x=>{
          x.addEventListener("click", (e)=>{
            const i = parseInt(e.target.getAttribute("data-idx"),10);
            files.splice(i,1);
            render();
          });
        });
        
        // Trigger file validation if FileValidator is loaded
        if (window.FileValidator && files.length > 0) {
          const validationContainer = zoneId === 'dzIngest' ? 'fileValidationInfo' : null;
          if (validationContainer) {
            window.FileValidator.displayValidationResults(files, validationContainer);
          }
        }
      }

      zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("dragover"); });
      zone.addEventListener("dragleave", ()=> zone.classList.remove("dragover"));
      zone.addEventListener("drop", (e)=>{
        e.preventDefault(); zone.classList.remove("dragover");
        if (e.dataTransfer.files && e.dataTransfer.files.length){
          files = files.concat(Array.from(e.dataTransfer.files));
          render();
        }
      });
      input.addEventListener("change", ()=>{
        if (input.files && input.files.length){
          files = files.concat(Array.from(input.files));
          render();
        }
      });

      return {
        getFiles: ()=> files.slice(),
        clear: ()=> { files = []; render(); }
      };
    }

    const dzIngest = initDropzone("dzIngest","ingFiles","ingFileList");
    const dzGen    = initDropzone("dzGen","gFiles","gFileList");

    // ======= INGEST =======
    document.getElementById("btnIngest").addEventListener("click", async ()=>{
      const out = document.getElementById("ingestOut");
      const pWrap = document.getElementById("ingProgressWrap");
      const pBar  = document.getElementById("ingProgress");
      const pTxt  = document.getElementById("ingProgressText");

      out.textContent = "Enviando...";
      const urlVal = document.getElementById("ingUrl").value.trim();
      const textVal = document.getElementById("ingText").value;
      const files = dzIngest.getFiles();
      let meta = undefined;
      const metaRaw = document.getElementById("ingMeta").value.trim();
      if (metaRaw) { try { meta = JSON.parse(metaRaw); } catch(e){ out.textContent = "Metadata inv√°lida: " + e.message; return; } }

      try {
        if (files.length > 0) {
          // Validate files before upload
          if (window.FileValidator) {
            const validation = window.FileValidator.validateFiles(files);
            if (!validation.valid) {
              out.textContent = "‚ùå Valida√ß√£o falhou:\n" + validation.errors.join('\n');
              return;
            }
          }
          
          // Use bulk-ingest for multiple files, regular ingest for single file
          const useBulkIngest = files.length > 1;
          const baseUrl = getBaseUrl();
          const endpoint = useBulkIngest ? baseUrl + "/api/rag/bulk-ingest" : baseUrl + "/api/rag/ingest";
          
          // multipart
          const fd = new FormData();
          files.forEach(f => fd.append("files[]", f, f.name));
          if (urlVal) fd.append("url", urlVal);
          if (textVal) fd.append("text", textVal);
          if (meta) fd.append("metadata", JSON.stringify(meta));
          fd.append("user_id", "1");

          pWrap.classList.remove("d-none");
          pBar.style.width = "0%"; pTxt.textContent = "0%";

          const data = await xhrMultipart("POST", endpoint.replace(baseUrl, ''), fd, (loaded,total)=>{
            const pct = Math.max(1, Math.floor((loaded/total)*100));
            pBar.style.width = pct+"%"; pTxt.textContent = pct+"%";
          });
          pretty(out, data);
          dzIngest.clear();
        } else {
          // json
          const payload = { url: urlVal || undefined, text: textVal, metadata: meta };
          const data = await doFetchJSON("POST","/api/rag/ingest", payload);
          pretty(out, data);
        }
      } catch (e) {
        out.textContent = "Erro: " + e.message;
      } finally {
        setTimeout(()=>{ pWrap.classList.add("d-none"); }, 600);
      }
    });

    // ======= QUERY =======
    document.getElementById("btnQuery").addEventListener("click", async ()=>{
      const out=document.getElementById("queryOut");
      out.textContent="Consultando...";
      const payload = {
        query: document.getElementById("qText").value,
        top_k: parseInt(document.getElementById("qTopK").value || "3", 10),
        temperature: parseFloat(document.getElementById("qTemp").value || "0") || undefined,
        max_tokens: parseInt(document.getElementById("qMaxTokens").value || "0", 10) || undefined
      };
      try{
        const data = await doFetchJSON("POST","/api/rag/query", payload);
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    // ======= LOAD LATEST DOCUMENT =======
    document.getElementById("btnLoadLatest").addEventListener("click", async ()=>{
      try{
        const data = await doFetchJSON("GET","/api/docs/list");
        if (data && data.docs && data.docs.length > 0) {
          const latest = data.docs[0]; // Primeiro √© o mais recente
          document.getElementById("aDocId").value = latest.id;
          console.log(`Carregado documento: ${latest.title} (ID: ${latest.id})`);
        }
      }catch(e){ console.error("Erro ao carregar documentos:", e); }
    });

    // ======= ANSWER =======
    document.getElementById("btnAnswer").addEventListener("click", async ()=>{
      const out=document.getElementById("answerOut");
      out.textContent="Gerando...";
      const payload = {
        query: document.getElementById("aText").value,
        document_id: parseInt(document.getElementById("aDocId").value || "125", 10),
        top_k: parseInt(document.getElementById("aTopK").value || "3", 10),
        model: document.getElementById("aModel").value.trim() || getModel()
      };
      try{
        const data = await doFetchJSON("POST","/api/rag/answer", payload);
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    // ======= VERTEX GENERATE (com upload) =======
    document.getElementById("btnGenGET").addEventListener("click", async ()=>{
      const out=document.getElementById("genOut");
      out.textContent="Chamando GET...";
      const params=new URLSearchParams();
      const p=document.getElementById("gPrompt").value;
      const m=document.getElementById("gModel").value.trim();
      const l=document.getElementById("gLoc").value.trim();
      if (p) params.set("prompt", p);
      if (m) params.set("model", m);
      if (l) params.set("location", l);
      // GET normalmente ignora corpo/arquivos; usado s√≥ para teste r√°pido
      try{
        const data = await doFetchJSON("GET","/api/vertex/generate?"+params.toString());
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    document.getElementById("btnGenPOST").addEventListener("click", async ()=>{
      const out=document.getElementById("genOut");
      const pWrap = document.getElementById("genProgressWrap");
      const pBar  = document.getElementById("genProgress");
      const pTxt  = document.getElementById("genProgressText");

      out.textContent="Chamando POST...";
      const files = dzGen.getFiles();
      const prompt = document.getElementById("gPrompt").value;
      const model  = document.getElementById("gModel").value.trim();
      const loc    = document.getElementById("gLoc").value.trim();

      try{
        if (files.length > 0){
          const fd = new FormData();
          fd.append("prompt", prompt);
          if (model) fd.append("model", model);
          if (loc)   fd.append("location", loc);
          files.forEach(f => fd.append("files[]", f, f.name));

          pWrap.classList.remove("d-none");
          pBar.style.width = "0%"; pTxt.textContent = "0%";

          const data = await xhrMultipart("POST","/api/vertex/generate", fd, (loaded,total)=>{
            const pct = Math.max(1, Math.floor((loaded/total)*100));
            pBar.style.width = pct+"%"; pTxt.textContent = pct+"%";
          });
          pretty(out, data);
          dzGen.clear();
        } else {
          const payload = { prompt, model: model || undefined, location: loc || undefined };
          const data = await doFetchJSON("POST","/api/vertex/generate", payload);
          pretty(out, data);
        }
      }catch(e){ out.textContent="Erro: "+e.message; }
      finally { setTimeout(()=>{ pWrap.classList.add("d-none"); }, 600); }
    });

    // ======= M√âTRICAS =======
    document.getElementById("btnMetrics").addEventListener("click", async ()=>{
      const out=document.getElementById("metricsOut");
      out.textContent="Carregando m√©tricas...";
      try{
        const data = await doFetchJSON("GET","/api/rag/metrics");
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    document.getElementById("btnCacheStats").addEventListener("click", async ()=>{
      const out=document.getElementById("metricsOut");
      out.textContent="Carregando estat√≠sticas de cache...";
      try{
        const data = await doFetchJSON("GET","/api/rag/cache/stats");
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    document.getElementById("btnEmbeddingsStats").addEventListener("click", async ()=>{
      const out=document.getElementById("metricsOut");
      out.textContent="Carregando estat√≠sticas de embeddings...";
      try{
        const data = await doFetchJSON("GET","/api/rag/embeddings/stats");
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    document.getElementById("btnClearCache").addEventListener("click", async ()=>{
      const out=document.getElementById("metricsOut");
      out.textContent="Limpando cache...";
      try{
        const data = await doFetchJSON("POST","/api/rag/cache/clear");
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    // ======= FEEDBACK ANALYTICS =======
    document.getElementById("btnFeedbackStats").addEventListener("click", async ()=>{
      const out=document.getElementById("metricsOut");
      out.textContent="Carregando estat√≠sticas de feedback...";
      try{
        const data = await doFetchJSON("GET","/api/rag/feedback/stats");
        
        if (data && data.ok) {
          const stats = data.stats;
          const topQueries = data.top_queries || [];
          const worstQueries = data.worst_queries || [];
          const topDocs = data.top_documents || [];
          const daily = data.daily_trend || [];
          
          let html = `
üìä ESTAT√çSTICAS DE FEEDBACK

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
RESUMO GERAL:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Total de feedbacks: ${stats.total_feedbacks}
Feedbacks positivos (üëç): ${stats.positive_feedbacks}
Feedbacks negativos (üëé): ${stats.negative_feedbacks}
Taxa de satisfa√ß√£o: ${stats.satisfaction_rate}%

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TOP 5 QUERIES COM MELHOR AVALIA√á√ÉO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${topQueries.length > 0 ? topQueries.map((q, i) => 
  `${i+1}. "${q.query.substring(0, 60)}${q.query.length > 60 ? '...' : ''}"
     Rating: ${q.avg_rating.toFixed(2)} | Avalia√ß√µes: ${q.count}`
).join('\n\n') : 'Sem dados suficientes (m√≠nimo 2 avalia√ß√µes por query)'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TOP 5 QUERIES COM PIOR AVALIA√á√ÉO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${worstQueries.length > 0 ? worstQueries.map((q, i) => 
  `${i+1}. "${q.query.substring(0, 60)}${q.query.length > 60 ? '...' : ''}"
     Rating: ${q.avg_rating.toFixed(2)} | Avalia√ß√µes: ${q.count}`
).join('\n\n') : 'Sem dados suficientes'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TOP 5 DOCUMENTOS COM MELHOR PERFORMANCE:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${topDocs.length > 0 ? topDocs.map((d, i) => 
  `${i+1}. Doc ID: ${d.document_id} - ${d.document ? d.document.title : 'Sem t√≠tulo'}
     Rating: ${d.avg_rating.toFixed(2)} | Avalia√ß√µes: ${d.count}`
).join('\n\n') : 'Sem dados suficientes (m√≠nimo 3 avalia√ß√µes por documento)'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TEND√äNCIA (√öLTIMOS 7 DIAS):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${daily.length > 0 ? daily.map(d => 
  `${d.date}: ${d.total} feedbacks (${d.positive} üëç / ${d.negative} üëé)`
).join('\n') : 'Sem dados nos √∫ltimos 7 dias'}
          `;
          
          out.textContent = html;
        } else {
          out.textContent = "Erro: " + (data.error || "Resposta inv√°lida");
        }
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    document.getElementById("btnRecentFeedbacks").addEventListener("click", async ()=>{
      const out=document.getElementById("metricsOut");
      out.textContent="Carregando feedbacks recentes...";
      try{
        const data = await doFetchJSON("GET","/api/rag/feedback/recent");
        
        if (data && data.ok) {
          const feedbacks = data.feedbacks || [];
          
          let html = `
üìù FEEDBACKS RECENTES (√öltimos 50)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Total: ${feedbacks.length} feedbacks
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${feedbacks.length > 0 ? feedbacks.map((f, i) => {
  const rating = f.rating === 1 ? 'üëç POSITIVO' : 'üëé NEGATIVO';
  const docInfo = f.document ? `Doc: ${f.document.title} (ID: ${f.document_id})` : 'Sem documento';
  const date = new Date(f.created_at).toLocaleString('pt-BR');
  
  return `${i+1}. ${rating} | ${date}
   Query: "${f.query.substring(0, 80)}${f.query.length > 80 ? '...' : ''}"
   ${docInfo}
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`;
}).join('\n') : 'Nenhum feedback encontrado'}
          `;
          
          out.textContent = html;
        } else {
          out.textContent = "Erro: " + (data.error || "Resposta inv√°lida");
        }
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    // ======= ADMIN =======
    document.getElementById("btnReprocessDoc").addEventListener("click", async ()=>{
      const out=document.getElementById("adminOut");
      const docId = document.getElementById("adminDocId").value;
      if (!docId) { out.textContent="Digite um Document ID"; return; }
      out.textContent="Reprocessando documento...";
      try{
        const data = await doFetchJSON("POST","/api/rag/reprocess-document", {document_id: parseInt(docId)});
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    document.getElementById("btnBatchIngest").addEventListener("click", async ()=>{
      const out=document.getElementById("adminOut");
      out.textContent="Upload em lote n√£o implementado no frontend ainda...";
    });

    document.getElementById("btnQualityIngest").addEventListener("click", async ()=>{
      const out=document.getElementById("adminOut");
      out.textContent="Upload com qualidade n√£o implementado no frontend ainda...";
    });

    document.getElementById("btnPreview").addEventListener("click", async ()=>{
      const out=document.getElementById("adminOut");
      out.textContent="Carregando preview...";
      try{
        const data = await doFetchJSON("GET","/api/rag/preview");
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    document.getElementById("btnDebugEcho").addEventListener("click", async ()=>{
      const out=document.getElementById("adminOut");
      out.textContent="Testando debug echo...";
      try{
        const data = await doFetchJSON("POST","/api/rag/debug/echo", {test: "debug message"});
        pretty(out, data);
      }catch(e){ out.textContent="Erro: "+e.message; }
    });

    // ======= CALCULADORA =======
    function calcCost(model, inCount, outCount=0, longCtx=false){
      const m = PRICING[model]; if(!m) return {error:"Modelo desconhecido"};
      const res = { model, unit:m.unit };
      if(m.unit==="tokens"){
        const inPerM = m.input_per_1M[longCtx?"long":"short"]; const inCost = (inCount/1_000_000)*inPerM;
        let outCost=0; if(m.output_per_1M){ const outPerM=m.output_per_1M[longCtx?"long":"short"]; outCost=(outCount/1_000_000)*outPerM; }
        res.input_cost=+inCost.toFixed(6); res.output_cost=+outCost.toFixed(6); res.total=+(inCost+outCost).toFixed(6); return res;
      } else {
        const inPerM=m.input_per_1M_chars||0, outPerM=m.output_per_1M_chars||0;
        const inCost=(inCount/1_000_000)*inPerM, outCost=(outCount/1_000_000)*outPerM;
        res.input_cost=+inCost.toFixed(6); res.output_cost=+outCost.toFixed(6); res.total=+(inCost+outCost).toFixed(6); return res;
      }
    }
    document.getElementById("btnCalc").addEventListener("click",()=>{
      const model=document.getElementById("ccModel").value, long=document.getElementById("ccLongCtx").checked;
      const inp=parseFloat(document.getElementById("ccIn").value||"0"), out=parseFloat(document.getElementById("ccOut").value||"0");
      const est = calcCost(model, inp, out, long);
      document.getElementById("ccOutArea").textContent=JSON.stringify(est,null,2);
    });

    // ======= PYTHON RAG =======
    document.getElementById("pythonSearchBtn").addEventListener("click", async ()=>{
      const query = document.getElementById("pythonQuery").value.trim();
      if (!query) {
        document.getElementById("pythonStatus").innerHTML = '<div class="alert alert-warning">Digite uma query</div>';
        return;
      }

      const topK = parseInt(document.getElementById("pythonTopK").value) || 5;
      const threshold = parseFloat(document.getElementById("pythonThreshold").value) || 0.3;
      const docId = document.getElementById("pythonDocId").value ? parseInt(document.getElementById("pythonDocId").value) : null;
      const includeAnswer = document.getElementById("pythonIncludeAnswer").checked;
      const strictness = parseInt(document.getElementById("pythonStrictness").value) || 2;
      const mode = document.getElementById("pythonMode").value || "auto";
      const format = document.getElementById("pythonFormat").value || "plain";
      const length = document.getElementById("pythonLength").value || "auto";
      const citations = parseInt(document.getElementById("pythonCitations").value) || 0;
      const useFullDocument = document.getElementById("pythonUseFullDocument").checked;
      const useSmartMode = document.getElementById("pythonUseSmartMode").checked;

      document.getElementById("pythonStatus").innerHTML = '<div class="alert alert-info">üîç Buscando com Python RAG...</div>';
      document.getElementById("pythonChunks").innerHTML = '';
      document.getElementById("pythonAnswer").innerHTML = '';
      document.getElementById("pythonMetadata").textContent = '';

      try {
        const payload = {
          query: query,
          top_k: topK,
          threshold: threshold,
          include_answer: includeAnswer,
          strictness: strictness,
          mode: mode,
          format: format,
          length: length,
          citations: citations,
          use_full_document: useFullDocument,
          use_smart_mode: useSmartMode
        };
        
        if (docId) payload.document_id = docId;

        const data = await doFetchJSON("POST", "/api/rag/python-search", payload);
        
        if (data.ok || data.success) {
          document.getElementById("pythonStatus").innerHTML = '<div class="alert alert-success">‚úÖ Busca conclu√≠da com sucesso!</div>';
          
          // Exibir chunks (novo formato)
          let chunksHtml = '';
          if (data.chunks && data.chunks.length > 0) {
            chunksHtml = data.chunks.map(chunk => 
              `<div class="border-bottom pb-2 mb-2">
                <strong>Chunk ID:</strong> ${chunk.id} | 
                <strong>Doc:</strong> ${chunk.document_id} | 
                <strong>Similarity:</strong> ${chunk.similarity ? chunk.similarity.toFixed(4) : 'N/A'}
                <br><small class="text-muted">${chunk.content.substring(0, 200)}${chunk.content.length > 200 ? '...' : ''}</small>
              </div>`
            ).join('');
          } else {
            chunksHtml = `<em>Nenhum chunk encontrado (${data.used_chunks ? data.used_chunks.length : 0} chunks usados)</em>`;
          }
          document.getElementById("pythonChunks").innerHTML = chunksHtml;
          
          // Exibir resposta
          document.getElementById("pythonAnswer").innerHTML = data.answer ? 
            `<div class="text-wrap">${data.answer.replace(/\n/g, '<br>')}</div>` : 
            '<em>Resposta n√£o gerada</em>';
          
          // DEFINIR METADADOS PRIMEIRO (antes de usar em feedback)
          const metadata = data.debug || data.metadata || {};
          
          // MOSTRAR BOT√ïES DE FEEDBACK ap√≥s resposta bem-sucedida
          if (data.answer) {
            // Armazena metadados globalmente para uso no feedback
            window.lastSearchMetadata = {
              query: query,
              document_id: docId,
              mode: mode,
              format: format,
              use_smart_mode: useSmartMode,
              response_metadata: metadata
            };
            
            // Mostra se√ß√£o de feedback
            document.getElementById("feedbackSection").style.display = "block";
            document.getElementById("feedbackStatus").style.display = "none";
            
            // Reseta bot√µes
            document.getElementById("feedbackThumbsUp").disabled = false;
            document.getElementById("feedbackThumbsDown").disabled = false;
            document.getElementById("feedbackThumbsUp").classList.remove("active", "btn-success");
            document.getElementById("feedbackThumbsDown").classList.remove("active", "btn-danger");
            document.getElementById("feedbackThumbsUp").classList.add("btn-outline-success");
            document.getElementById("feedbackThumbsDown").classList.add("btn-outline-danger");
          }
          
          // Exibir metadados (novo formato com Smart Router info)
          const displayData = {
            mode_used: data.mode_used,
            format: data.format,
            sources: data.sources,
            used_chunks: data.used_chunks,
            smart_router: metadata.smart_router || null,
            cache_hit: metadata.cache_hit || false,
            cache_level: metadata.cache_level || null,
            debug: metadata
          };
          document.getElementById("pythonMetadata").textContent = JSON.stringify(displayData, null, 2);
          
          // Exibir badge se usou Smart Router
          if (metadata.smart_router) {
            const smartInfo = metadata.smart_router;
            const badge = `<span class="badge bg-info ms-2">üß† Smart: ${smartInfo.strategy}</span>`;
            document.getElementById("pythonStatus").innerHTML += badge;
          }
          
          // Exibir badge se veio do cache
          if (metadata.cache_hit) {
            const cacheBadge = `<span class="badge bg-success ms-2">‚ö° Cache ${metadata.cache_level}</span>`;
            document.getElementById("pythonStatus").innerHTML += cacheBadge;
          }
          
        } else {
          document.getElementById("pythonStatus").innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${data.error}</div>`;
        }
        
      } catch(e) {
        document.getElementById("pythonStatus").innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${e.message}</div>`;
      }
    });

    document.getElementById("pythonCompareBtn").addEventListener("click", async ()=>{
      const query = document.getElementById("pythonQuery").value.trim();
      if (!query) {
        document.getElementById("pythonStatus").innerHTML = '<div class="alert alert-warning">Digite uma query para comparar</div>';
        return;
      }

      const topK = parseInt(document.getElementById("pythonTopK").value) || 5;
      const docId = document.getElementById("pythonDocId").value ? parseInt(document.getElementById("pythonDocId").value) : null;

      document.getElementById("pythonStatus").innerHTML = '<div class="alert alert-info">‚öñÔ∏è Comparando PHP vs Python...</div>';

      try {
        const payload = {
          query: query,
          top_k: topK
        };
        
        if (docId) payload.document_id = docId;

        const data = await doFetchJSON("POST", "/api/rag/compare-search", payload);
        
        if (data.success) {
          const php = data.comparison.php;
          const python = data.comparison.python;
          
          document.getElementById("pythonStatus").innerHTML = `
            <div class="alert alert-success">
              <h6>üìä Compara√ß√£o PHP vs Python</h6>
              <div class="row">
                <div class="col-6">
                  <strong>PHP (FTS):</strong><br>
                  ‚úÖ Sucesso: ${php.success}<br>
                  üìÑ Chunks: ${php.chunks_found}<br>
                  ‚è±Ô∏è Tempo: ${php.execution_time}s
                </div>
                <div class="col-6">
                  <strong>Python (Vector):</strong><br>
                  ‚úÖ Sucesso: ${python.success}<br>
                  üìÑ Chunks: ${python.chunks_found}<br>
                  ‚è±Ô∏è Tempo: ${python.execution_time}s
                </div>
              </div>
              <hr>
              <strong>üèÜ Vencedor:</strong> Velocidade: ${data.winner.speed} | Chunks: ${data.winner.chunks}
            </div>
          `;
          
          document.getElementById("pythonMetadata").textContent = JSON.stringify(data, null, 2);
          
        } else {
          document.getElementById("pythonStatus").innerHTML = `<div class="alert alert-danger">‚ùå Erro na compara√ß√£o: ${data.error}</div>`;
        }
        
      } catch(e) {
        document.getElementById("pythonStatus").innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${e.message}</div>`;
      }
    });

    document.getElementById("pythonHealthBtn").addEventListener("click", async ()=>{
      document.getElementById("pythonStatus").innerHTML = '<div class="alert alert-info">üè• Verificando sa√∫de do sistema Python...</div>';

      try {
        const data = await doFetchJSON("GET", "/api/rag/python-health");
        
        if (data.success) {
          document.getElementById("pythonStatus").innerHTML = `
            <div class="alert alert-success">
              <h6>üè• Sistema Python RAG - Saud√°vel</h6>
              <div class="row">
                <div class="col-6">
                  <strong>Python:</strong> ${data.python_version}<br>
                  <strong>Script:</strong> ‚úÖ Encontrado<br>
                  <strong>Depend√™ncias:</strong> ‚úÖ OK
                </div>
                <div class="col-6">
                  <strong>Docs:</strong> ${data.database_stats.total_documents}<br>
                  <strong>Chunks:</strong> ${data.database_stats.total_chunks}<br>
                  <strong>Embeddings:</strong> ${data.database_stats.chunks_with_embeddings} (${data.database_stats.embedding_coverage}%)
                </div>
              </div>
            </div>
          `;
          
          document.getElementById("pythonMetadata").textContent = JSON.stringify(data, null, 2);
          
        } else {
          document.getElementById("pythonStatus").innerHTML = `<div class="alert alert-danger">‚ùå Sistema com problemas: ${data.error}</div>`;
        }
        
      } catch(e) {
        document.getElementById("pythonStatus").innerHTML = `<div class="alert alert-danger">‚ùå Erro: ${e.message}</div>`;
      }
    });

  </script>
  <!-- ADICIONE esta linha no final do seu index.html, antes de fechar </body> -->
<script src="./rag-client.js"></script>

<script>
  // Fun√ß√£o para carregar documentos da API
  async function loadDocuments() {
    try {
      const response = await fetch('/api/docs/list');
      const data = await response.json();
      
      if (data && data.docs && Array.isArray(data.docs)) {
        const pythonSelect = document.getElementById('pythonDocSelect');
        const answerSelect = document.getElementById('answerDocSelect');
        
        // Limpa op√ß√µes existentes
        pythonSelect.innerHTML = '<option value="">Selecione um documento...</option>';
        answerSelect.innerHTML = '<option value="">Selecione um documento...</option>';
        
        // Filtra documentos: remove fixtures (ID >= 9000) e arquivos de teste
        const realDocs = data.docs.filter(doc => {
          return doc.id < 9000 && 
                 !doc.title.startsWith('test_') && 
                 !doc.title.startsWith('Fixture');
        });
        
        // Ordena por ID decrescente (mais recentes primeiro)
        realDocs.sort((a, b) => b.id - a.id);
        
        // Adiciona documentos reais
        realDocs.slice(0, 15).forEach(doc => {
          // Melhora a formata√ß√£o do nome
          let displayName = doc.title;
          let fileIcon = 'üìÑ'; // √≠cone padr√£o
          
          // Define √≠cone baseado na extens√£o (s√≠mbolos universais reconhec√≠veis)
          if (displayName.endsWith('.pdf')) {
            fileIcon = 'üìï'; // Adobe PDF - documento vermelho cl√°ssico
            displayName = displayName.replace('.pdf', '');
          } else if (displayName.endsWith('.docx') || displayName.endsWith('.doc')) {
            fileIcon = 'üìò'; // Microsoft Word - documento azul cl√°ssico
            displayName = displayName.replace('.docx', '').replace('.doc', '');
          } else if (displayName.endsWith('.xlsx') || displayName.endsWith('.xls')) {
            fileIcon = 'üìó'; // Microsoft Excel - planilha verde cl√°ssica
            displayName = displayName.replace('.xlsx', '').replace('.xls', '');
          } else if (displayName.endsWith('.pptx') || displayName.endsWith('.ppt')) {
            fileIcon = 'üìô'; // Microsoft PowerPoint - apresenta√ß√£o laranja cl√°ssica
            displayName = displayName.replace('.pptx', '').replace('.ppt', '');
          } else if (displayName.endsWith('.txt')) {
            fileIcon = 'üìÑ'; // Arquivo de texto simples
            displayName = displayName.replace('.txt', '');
          } else if (displayName.endsWith('.csv')) {
            fileIcon = 'üìä'; // Planilha de dados CSV
            displayName = displayName.replace('.csv', '');
          } else if (displayName.endsWith('.html') || displayName.endsWith('.htm')) {
            fileIcon = 'üåê'; // HTML - p√°gina web
            displayName = displayName.replace('.html', '').replace('.htm', '');
          } else if (displayName.endsWith('.xml')) {
            fileIcon = 'üìã'; // XML - dados estruturados
            displayName = displayName.replace('.xml', '');
          } else if (displayName.endsWith('.rtf')) {
            fileIcon = 'üìù'; // RTF - texto formatado
            displayName = displayName.replace('.rtf', '');
          }
          
          // Remove "(1)" de arquivos duplicados
          displayName = displayName.replace(' (1)', '');
          
          const optionText = `${fileIcon} ${displayName}`;
          
          // Python RAG Select
          const pythonOption = document.createElement('option');
          pythonOption.value = doc.id;
          pythonOption.textContent = optionText;
          pythonOption.title = `ID: ${doc.id} | Chunks: ${doc.chunks || 0} | Tipo: ${fileIcon}`;
          pythonSelect.appendChild(pythonOption);
          
          // Answer Select
          const answerOption = document.createElement('option');
          answerOption.value = doc.id;
          answerOption.textContent = optionText;
          answerOption.title = `ID: ${doc.id} | Chunks: ${doc.chunks || 0} | Tipo: ${fileIcon}`;
          answerSelect.appendChild(answerOption);
        });
        
        console.log(`‚úì ${realDocs.length} documentos reais carregados nos selects (filtrados de ${data.docs.length} total)`);
      }
    } catch (error) {
      console.error('Erro ao carregar documentos:', error);
      document.getElementById('pythonDocSelect').innerHTML = '<option value="">Erro ao carregar documentos</option>';
      document.getElementById('answerDocSelect').innerHTML = '<option value="">Erro ao carregar documentos</option>';
    }
  }

  // Event listeners para alternar entre select e input manual
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle para Python RAG
    document.getElementById('toggleDocInput').addEventListener('click', function() {
      const select = document.getElementById('pythonDocSelect');
      const input = document.getElementById('pythonDocId');
      
      if (select.style.display !== 'none') {
        select.style.display = 'none';
        input.style.display = 'block';
        this.innerHTML = 'üìã';
        this.title = 'Voltar para select de documentos';
      } else {
        select.style.display = 'block';
        input.style.display = 'none';
        this.innerHTML = 'üî¢';
        this.title = 'Alternar entre select e input manual';
      }
    });
    
    // Toggle para Answer
    document.getElementById('toggleAnswerDocInput').addEventListener('click', function() {
      const select = document.getElementById('answerDocSelect');
      const input = document.getElementById('aDocId');
      
      if (select.style.display !== 'none') {
        select.style.display = 'none';
        input.style.display = 'block';
        this.innerHTML = 'üìã';
        this.title = 'Voltar para select de documentos';
      } else {
        select.style.display = 'block';
        input.style.display = 'none';
        this.innerHTML = 'üî¢';
        this.title = 'Alternar entre select e input manual';
      }
    });
    
    // Sync entre select e input para Python RAG
    document.getElementById('pythonDocSelect').addEventListener('change', function() {
      document.getElementById('pythonDocId').value = this.value;
      // Trigger change event para carregar perguntas sugeridas
      document.getElementById('pythonDocId').dispatchEvent(new Event('change'));
    });
    
    // Sync entre select e input para Answer
    document.getElementById('answerDocSelect').addEventListener('change', function() {
      document.getElementById('aDocId').value = this.value;
    });
  });

  // Carregar perguntas sugeridas quando documento for selecionado
  // IMPORTANTE: Deve estar DEPOIS do rag-client.js para window.RAG existir
  window.addEventListener("load", function() {
    // Carrega documentos automaticamente
    loadDocuments();
    
    // Aguarda um pouco para garantir que window.RAG est√° dispon√≠vel
    setTimeout(function() {
      if (!window.RAG) {
        console.error("window.RAG n√£o est√° dispon√≠vel!");
        return;
      }
      
      console.log("‚úì window.RAG dispon√≠vel, registrando event listener");
      
      document.getElementById("pythonDocId").addEventListener("change", async function() {
        const docId = parseInt(this.value);
        console.log("Event change disparado, docId:", docId);
        
        if (!docId) {
          document.getElementById("pythonSuggestedQuestions").style.display = "none";
          return;
        }

        try {
          console.log("Buscando perguntas para doc", docId);
          const questions = await window.RAG.getSuggestedQuestions(docId);
          console.log("Perguntas recebidas:", questions ? questions.length : 0);
          
          if (questions && questions.length > 0) {
            const listEl = document.getElementById("pythonSuggestedList");
            listEl.innerHTML = '';
            
            questions.forEach(q => {
              const btn = document.createElement("button");
              btn.className = "btn btn-sm btn-outline-primary";
              btn.textContent = q;
              btn.onclick = () => {
                document.getElementById("pythonQuery").value = q;
              };
              listEl.appendChild(btn);
            });
            
            document.getElementById("pythonSuggestedQuestions").style.display = "block";
            console.log("‚úì Perguntas exibidas!");
          } else {
            document.getElementById("pythonSuggestedQuestions").style.display = "none";
            console.log("Nenhuma pergunta encontrada");
          }
        } catch(e) {
          console.error("Erro ao carregar perguntas sugeridas:", e);
        }
      });
    }, 100);
  });
  
  // FEEDBACK SYSTEM - Event listeners para bot√µes üëçüëé
  
  // Bot√£o Thumbs Up
  document.getElementById("feedbackThumbsUp").addEventListener("click", async function() {
    if (!window.lastSearchMetadata) {
      alert("Nenhuma busca ativa para avaliar.");
      return;
    }
    
    try {
      const result = await window.RAG.submitFeedback({
        query: window.lastSearchMetadata.query,
        document_id: window.lastSearchMetadata.document_id,
        rating: 1,
        metadata: window.lastSearchMetadata
      });
      
      if (result && result.ok) {
        document.getElementById("feedbackStatus").textContent = "‚úì Obrigado pelo feedback!";
        document.getElementById("feedbackStatus").style.display = "inline";
        
        // Destaca bot√£o clicado
        this.disabled = true;
        document.getElementById("feedbackThumbsDown").disabled = true;
        this.classList.remove("btn-outline-success");
        this.classList.add("btn-success", "active");
      } else {
        alert("Erro ao salvar feedback: " + (result.error || "Desconhecido"));
      }
    } catch (e) {
      console.error("Erro ao enviar feedback:", e);
      alert("Erro ao enviar feedback: " + e.message);
    }
  });
  
  // Bot√£o Thumbs Down
  document.getElementById("feedbackThumbsDown").addEventListener("click", async function() {
    if (!window.lastSearchMetadata) {
      alert("Nenhuma busca ativa para avaliar.");
      return;
    }
    
    try {
      const result = await window.RAG.submitFeedback({
        query: window.lastSearchMetadata.query,
        document_id: window.lastSearchMetadata.document_id,
        rating: -1,
        metadata: window.lastSearchMetadata
      });
      
      if (result && result.ok) {
        document.getElementById("feedbackStatus").textContent = "‚úì Obrigado pelo feedback! Vamos melhorar.";
        document.getElementById("feedbackStatus").style.display = "inline";
        
        // Destaca bot√£o clicado
        this.disabled = true;
        document.getElementById("feedbackThumbsUp").disabled = true;
        this.classList.remove("btn-outline-danger");
        this.classList.add("btn-danger", "active");
      } else {
        alert("Erro ao salvar feedback: " + (result.error || "Desconhecido"));
      }
    } catch (e) {
      console.error("Erro ao enviar feedback:", e);
      alert("Erro ao enviar feedback: " + e.message);
    }
  });
</script>

</body>
</html>
